# Домашняя работа 1 по курсу "Машинное обучение"

> Курс "Машинное обучение" в рамках магистерской программы "Искусственный интеллект"

P.S. Приложение доступно по [ссылке](https://segorfirstapp.streamlit.app) 

## EDA
### 1. Просмотр данных 
#### 1.1 Первичный просмотр данных
В рамках "беглого" просмотра были выявлены пропущенные значения и некоторое количество дубликатов. Большую обеспокоенность вызывало немалая часть категориальных текстовых признаков. 

Некоторое число предпологаемых числовых признаков были "зашумлены" текстом, описывающим единицы измерения или не были разбиты на два различных признака при парсинге. 

К категориальным признакам в конечных наилучших моделях также было отнесено количество посадочных мест - `seats`. 

#### 1.2 Более глубокий просмотр данных 
По графику __pairplot__ были сделаны следующие выводы:
1. По некоторым графикам можно действительно определить связь, например, 
    - Чем старше автомобиль, тем дешевле он (связь похожа на экспоненциальную)
    - Пробег значительно удешевляет автомобиль (связь похожа на логарифмическую)
    - Автомобили с бОльшим объемом двигателя более дорогие (можно сказать, что связь линейная)
    - С max_power скорее тоже линейная связь

2. Да, если между признаками существует линейная связь, то scatter должны выстраиваться в линию, например, как между 
    - torque и max_power
    - torque и engine
    - max_power и engine,
    - selling_price и torque
    - selling_price и max_power

Чтобы действительно проверить их взаимосвязь, необходимо посмотреть на корреляцию между признаками. 

По графику корреляционной матрицы можно сразу обратить внимание на наименее скоррелированы между собой признаки - `engine` и `year`.
Довольно сильную положительную корреляцию будем считать >= 0.7 по модулю, а это `max_power и torque`, `engine и max_power`, `max_power и selling_price`. Таким образом, предположение о взаимосвязи, сделанное по диаграммам рессеяния, подтвердилось в 2/5 предположенных пар. Предположение о том, что более "возрастной" автомобиль будет иметь бОльший пробег с одной стороны подтверждается, с другой стороны, не очень, так как наблюдается умеренная (не очень сильная) обратная линейная взаимосвязь - (-0.47). Вероятнее всего, существуют какие-то ретро-автомобили, которым сменили мотор и, не смотря, на то, что на нем еще гонял Генри Форд, пробег будет небольшой из-за ремонта, с другой стороны, могут быть автомобили Я.Go, которые за полгода могли 8 раз проехать всю землю. 

### 2. Сравнение тестовой и трейновой выборок
Между обучающей и тестовой выборками нет существенных различий, средние значения и медианы для признаков приблизительно равны, однако стандартное отклонение для `selling_price` и `km_driven` великовато, что может говорить о наличии каких-то выбросов. Существенное различие для `selling_price` уже в целом подтверждает высказанные предположения о наличии выбросов. Вероятнее всего это какие-то дорогостоящие автомобили. В обучающую выборку попали объекты с бОльшим размахом, охватывая бОльшую выборку. Вероятнее всего, разбиение на выборки сделано корректно.

В ходе исследования были неоднократно обнаружены признаки наличия выбросов, поэтому для подтверждения или опровержения этого, дополнительно были построены графики ящика с усами и виолончель для цены (таргета) и наиболее "подозрительного" признака - пробег. Предположение о наличии выбросов подтвердилось. Обработка выбросов описана в п. 2


## 2. Предобработка признаков
Как говорилось в п. 1, в признаках также присуствовали колонки типа "object", хотя они предполагали быть числовыми - это `mileage`, `engine`, `max_power` и `torque`. Столбцы `mileage`, `engine` и `max_power` были переведены в числовые путем удаления _str-значений_. Признак `torque` пришлось парсить гигантским числом условий, более того некоторые значения были в разных единицах измерения, все они были приведены к международной системе Nm - Ньютон-метры. 

Пропущенные значения по пути наименьшего сопротивления были заполнены медианой, подбор другого способа, который улучшил бы метрики качества моделей я не выполнял, так как был доволен конечным результатом моделей. 

В ходе просмотра данных были обнаружены выбросы. Поэтому для автоматизации процесса я "обрезал" все значения числовых признаков, выходящие за пределы 1.5IQR. 

Самый проблемный признак - `name` содержал много полезной информации. Этот признак был разбит на следующие колонки `brand`, `drive`, `model`, `fuel`, `engine_displacement`, `is_sport`, `transmission`, `body_type`, `trim`, `emission_norm`, `series`. Однако после разбиения было замечено, что `fuel` и `transmission` уже есть в исходных данных, которые имеют меньшее число пропусков, поэтому эти "новые" признаки из `name` были удалены. Таким образом, из `name` мы получили 9 новых признаков. 

Также для финальной модели по подсказке признак года был изменен на его квадрат, а также объеденены некоторые категории признака `owner`. По диаграмме рассеяния видно, что второй владелец в наибольшей степени похож на первого владельца, за исключением выбросов, аналогично для 3-го и 4-го, поэтому их можно объединить так: 1-2 владелец, 3-4 владелец, тест-драйв вообще сам по себе как-то, его просто выбросим.

__Из рассмотрения графиков распределения:__\
На графике `milleage` видно нормальное распределение, графики `year<sup>2</sup>`, `torque`, `max_power` и `horse×volume` похожи на нормальное распределение со скошенностью.

В ходе предобработки все признаки кроме milleage (так как уже нормальное распределение) и seats (так как дальше этот признак будет использоваться как категориальный) были прологарифмирорваны.

## 3. Модели
### Метрики качества
В качестве базовых метрик качества использовались R<sup>2</sup> и MSE. 

### Спецификация моделей
В ходе выполнения работы был обучен ряд стандартных моделей:
1. Линейная регрессия только на числовых признаках
2. Линйная регрессия на стандартизированных числовых признаках
3. Линейная регрессия с L1-регуляризацией на стандартизированных числовых признаках
4. Линейная регрессия с L1-регуляризацией на стандартизированных числовых признаках с подбором гиперпараметров модели с кросс-валидацией на 10-ти фолдах.
5. Линейная регрессия с ElasticNet-регуляризацией на стандартизированных числовых признаках с подбором гиперпараметров модели с кросс-валидацией на 10-ти фолдах.\
_Оговорка:_ только при написании README было замечено, что в сетке параметров не был добавлен l1_ratio для ElasticNet, в связи с чем, думаю, что это существенно ухудшило потенциальное качество модели.
> (6.) Линейная регрессия с L0-регуляризацией не была реализована, так как показалась максимально сложной и не стоящей 0.35/7 баллов
6. Ridge регрессия на категориальных признаках
7. Ridge регрессия на полном датасете с добавлением новых признаков, обработкой выбросов и изменением некоторых признаков. 

### Качество моделей

| Метрики     | Модель 1       | Модель 2        | Модель 3        | Модель 4        | Модель 5        | Модель 6       | Модель 7      |
|-------------|----------------|-----------------|-----------------|-----------------|-----------------|----------------|---------------|
|R<sup>2</sup>| 0.6            | 0.6             | 0.6             | 0.59            | 0.6             | 0.93           | 0.95          |
| MSE         |229962033471.11 | 229962033471.11 | 229962763439.38 | 233166306225.36 | 229962399179.72 | 39897937446.78 | 28450913580.56|

Как видим по таблице, наилучшими моделями оказались две последние, включающие в себя категориальные признаки. Абсолютным лидером по текущим метрикам стала последняя "авторская" модель.

Далее будут рассматриваться только 2 последние модели

## 4. Бизнес-метрики

Помимо офлайн-метрики были расчитаны две бизнес-метрики:
1. Доля прогнозов, отличающихся от реальных цен на эти авто не более чем на 10% 
2. Ассиметричная взвешенная MSE на процентной ошибке (согласно ей лучшая модель обладает меньшей ошибкой)

| Метрики     | Модель 6       | Модель 7      |
|-------------|----------------|---------------|
|R<sup>2</sup>| 0.93           | 0.95          |
| MSE         | 39897937446.78 | 28450913580.56|
| B10         | 0.39           | 0.44          |
| WMSPE       | 0.16           | 0.23          |

Согласно бизнес-метрикам __Модель 7__ оказалась лучше по _B10_: доля прогнозов не выходящих за &plusmn;10% от истинной цены оказалась выше, чем для __Модели 6__, __Модель 6__ обходит __Модель 7__  только лишь по метрике _WMSPE_: при α=0.9 она показывает меньшую взвешенную ошибку (0.16 против 0.23), что указывает на лучший контроль заниженных прогнозов при их большей важности.

## 5. [Приложение](https://segorfirstapp.streamlit.app)
### Удобство
Я старался сделать максимально user-friendly приложение, которое было бы наивно понятно каждому: например, обычный обыватель будет делать запрос для 1-го автомобиля, поэтому сразу "открывапть" форму с загрузкой csv-файла необязательно. Более того, так как по бизнем-метрикам между собой пальму первенства делят __Модель 6__ и __Модель 7__, в приложение было встроено сразу 2 модели. 

Также в приложение встроены все предобработки данных, поэтому в него можно загружать сырые данные: с выбросами, искаженные числовые признаки с текстом и полное описание автомобиля в графу "Название"

### Визуализация
В разделе визуализации представлены полученные на этапе __EDA__ графики с кратким описанием и выводами.

Визуализация весов модели оказалась самой проблемной, так как наибольшее число признаков оказалось у __Модели 7__ - более 1000 признаков. 

### На будущее
В дальнейшем хотелось бы вывести загрузку CSV вообще на другую страницу, чтобы не было полей ввода для прогнозов 1 объекта

## Рефлексия
Последняя модель, на которую дали полностью "развязанные руки", вопреки ожиданиям оказалась очень даже неплохой. По офлайн-метрикам оказалась даже лучшей. 

С другой стороны, не была реализована L0-регуляризация о которой я буду думать еще несколько лет (до сих пор не могу простить себя за то, что ушел с МО2 из-за домашки по EM-алгоритму, но обещаю, что выучу его когда-нибудь..)

Также большой бедой сейчас для меня стал пропуск подбора гиперпараметра l1_ratio для ElasticNet